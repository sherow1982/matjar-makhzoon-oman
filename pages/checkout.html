<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="../images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุชูุงู ุงูุทูุจ ุงูุขูู - ูุฎุฒูู ุนูุงู</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <script src="../main.js" defer></script>
    <script src="../loader.js" defer></script>
</head>
<body class="checkout-page-body">

    <!-- ููุฏุฑ ูุจุณุท ููุฏูุน -->
    <header class="checkout-header">
        <div class="container">
            <a href="../index.html" class="logo">
                <span class="omani-red">ูุฎุฒูู</span> <span class="omani-green">ุนูุงู</span>
            </a>
            <div class="secure-badge"><i class="fas fa-lock"></i> ุฏูุน ุขูู 100%</div>
        </div>
    </header>

    <div class="container">
        <!-- ุดุฑูุท ุงูุฎุทูุงุช -->
        <div class="checkout-steps">
            <div class="step completed">
                <div class="step-icon"><i class="fas fa-shopping-cart"></i></div>
                <span>ุงูุณูุฉ</span>
            </div>
            <div class="step active">
                <div class="step-icon"><i class="fas fa-map-marker-alt"></i></div>
                <span>ุงูุนููุงู</span>
            </div>
            <div class="step">
                <div class="step-icon"><i class="fas fa-check"></i></div>
                <span>ุงูุชุฃููุฏ</span>
            </div>
            <div class="line"></div>
        </div>

        <div class="checkout-layout">
            
            <!-- ุงูุนููุฏ ุงูุฃููู: ูููุฐุฌ ุงูุจูุงูุงุช -->
            <div class="checkout-main">
                <div class="form-card fade-in">
                    <h2 class="form-title">ุจูุงูุงุช ุงูุชูุตูู</h2>
                    
                    <form id="checkout-form" onsubmit="processOrder(event)">
                        <!-- ุงูุงุณู -->
                        <div class="input-group">
                            <label>ุงูุงุณู ุงููุงูู</label>
                            <div class="input-wrapper">
                                <i class="fas fa-user"></i>
                                <input type="text" id="c_name" required placeholder="ุงุฏุฎู ุงุณูู ููุง..">
                            </div>
                        </div>

                        <!-- ุงููุงุชู -->
                        <div class="input-group">
                            <label>ุฑูู ุงููุงุชู (ูุงุชุณุงุจ)</label>
                            <div class="input-wrapper">
                                <i class="fas fa-mobile-alt"></i>
                                <input type="tel" id="c_phone" required placeholder="9xxxxxxx">
                            </div>
                            <small style="color:#777; font-size:12px; margin-top:5px; display:block">ุณูุฑุณู ูู ุชูุงุตูู ุงูุทูุจ ุนุจุฑ ูุงุชุณุงุจ ูุชุฃููุฏู.</small>
                        </div>

                        <!-- ุงููุฏููุฉ ูุงูุนููุงู -->
                        <div class="row-group">
                            <div class="input-group">
                                <label>ุงููุญุงูุธุฉ</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-map"></i>
                                    <select id="c_city" required>
                                        <option value="" disabled selected>ุงุฎุชุฑ ุงููุญุงูุธุฉ</option>
                                        <option value="ูุณูุท">ูุณูุท</option>
                                        <option value="ุธูุงุฑ">ุธูุงุฑ</option>
                                        <option value="ูุณูุฏู">ูุณูุฏู</option>
                                        <option value="ุงูุจุฑููู">ุงูุจุฑููู</option>
                                        <option value="ุงูุฏุงุฎููุฉ">ุงูุฏุงุฎููุฉ</option>
                                        <option value="ุดูุงู ุงูุจุงุทูุฉ">ุดูุงู ุงูุจุงุทูุฉ</option>
                                        <option value="ุฌููุจ ุงูุจุงุทูุฉ">ุฌููุจ ุงูุจุงุทูุฉ</option>
                                        <option value="ุงูุธุงูุฑุฉ">ุงูุธุงูุฑุฉ</option>
                                        <option value="ุดูุงู ุงูุดุฑููุฉ">ุดูุงู ุงูุดุฑููุฉ</option>
                                        <option value="ุฌููุจ ุงูุดุฑููุฉ">ุฌููุจ ุงูุดุฑููุฉ</option>
                                        <option value="ุงููุณุทู">ุงููุณุทู</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>ุงูููุทูุฉ / ุงูุนููุงู</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-home"></i>
                                    <input type="text" id="c_address" required placeholder="ุณูุทูุฉ ุนูุงูุจูู...">
                                </div>
                            </div>
                        </div>

                        <!-- ุทุฑููุฉ ุงูุฏูุน -->
                        <div class="payment-method-box">
                            <label class="radio-container">
                                <input type="radio" checked name="payment" disabled>
                                <span class="radio-checkmark"></span>
                                <div class="payment-details">
                                    <span class="pay-title">ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู (COD)</span>
                                    <span class="pay-desc">ุงุฏูุน ููุฏุงู ุนูุฏ ูุตูู ุงูุทูุจ ูุจุงุจ ุจูุชู.</span>
                                </div>
                                <i class="fas fa-money-bill-wave payment-icon"></i>
                            </label>
                        </div>

                        <button type="submit" class="btn-checkout-submit">
                            <span>ุชุฃููุฏ ุงูุทูุจ ุงูุขู</span>
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </form>
                </div>
                
                <div class="trust-icons">
                    <div><i class="fas fa-shield-alt"></i> ุถูุงู ุงูุฌูุฏุฉ</div>
                    <div><i class="fas fa-sync"></i> ุงุณุชุฑุฌุงุน ุณูู</div>
                    <div><i class="fas fa-headset"></i> ุฏุนู ููู</div>
                </div>
            </div>

            <!-- ุงูุนููุฏ ุงูุฃูุณุฑ: ููุฎุต ุงูุทูุจ -->
            <div class="checkout-sidebar">
                <div class="summary-card">
                    <h3>ููุฎุต ุงูุทูุจ</h3>
                    <div id="checkout-items" class="summary-items-list">
                        <!-- ุณูุชู ุชุนุจุฆุฉ ุงูููุชุฌุงุช ููุง -->
                    </div>
                    
                    <div class="summary-totals">
                        <div class="total-row">
                            <span>ุงููุฌููุน ุงููุฑุนู</span>
                            <span id="sub-total">0.00 ุฑ.ุน.</span>
                        </div>
                        <div class="total-row">
                            <span>ุงูุดุญู</span>
                            <span style="color:var(--omani-black)">ูุฌุงูู ููุชุฑุฉ ูุญุฏูุฏุฉ</span>
                        </div>
                        <div class="divider"></div>
                        <div class="total-row final">
                            <span>ุงูุฅุฌูุงูู ุงูููู</span>
                            <span id="final-total">0.00 ุฑ.ุน.</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ุงูููุชุฑ -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025 ูุชุฌุฑ ูุฎุฒูู ุนูุงู</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ุงุณุชุฎุฏุงู ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ ูุงูููุธูุฉ ูุชุญููู ุงูุจูุงูุงุช
            loadApp().then(() => {
                loadCheckoutPage();
            }).catch(err => console.error("Failed to load checkout page:", err));
        });

        function loadCheckoutPage() {
            const cart = getCart();
            if (cart.length === 0) {
                // ุฅุฐุง ูุงูุช ุงูุณูุฉ ูุงุฑุบุฉุ ุฃุนุฏ ุงููุณุชุฎุฏู ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
                window.location.href = '../index.html';
                return;
            }

            const itemsContainer = document.getElementById('checkout-items');
            const subTotalEl = document.getElementById('sub-total');
            const finalTotalEl = document.getElementById('final-total');
            let itemsHTML = '';
            let total = 0;

            for (const cartItem of cart) {
                const product = window.allProducts.find(p => p.id === cartItem.id);
                if (product) {
                    const itemTotal = product.sale_price * cartItem.quantity;
                    total += itemTotal;
                    itemsHTML += `
                        <div class="summary-item">
                            <img src="${product['image link'].startsWith('http') ? product['image link'] : `../${product['image link']}`}" alt="${product.title}">
                            <div class="summary-item-details">
                                <h4>${product.title}</h4>
                                <span>${cartItem.quantity} x ${product.sale_price.toFixed(2)} ุฑ.ุน.</span>
                            </div>
                            <span class="summary-item-price">${itemTotal.toFixed(2)} ุฑ.ุน.</span>
                        </div>
                    `;
                }
            }

            itemsContainer.innerHTML = itemsHTML;
            subTotalEl.textContent = `${total.toFixed(2)} ุฑ.ุน.`;
            finalTotalEl.textContent = `${total.toFixed(2)} ุฑ.ุน.`;
        }

        // ุฏุงูุฉ ุฎุงุตุฉ ุจุงูุตูุญุฉ (Process Order)
        async function processOrder(e) {
            e.preventDefault();
            const name = document.getElementById('c_name').value.trim();
            const phone = document.getElementById('c_phone').value.trim();
            const city = document.getElementById('c_city').value;
            const address = document.getElementById('c_address').value.trim();

            // ุงูุชุญูู ูู ุตุญุฉ ุฑูู ุงููุงุชู
            const phoneRegex = /^[79]\d{7}$/;
            if (!phoneRegex.test(phone)) {
                alert("ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูุงุชู ุตุญูุญ (8 ุฃุฑูุงู ุชุจุฏุฃ ุจู 7 ุฃู 9).");
                return;
            }

            const cart = getCart();
            if (cart.length === 0) return;
            
            let msg = `*ุทูุจ ุฌุฏูุฏ (ูุฎุฒูู ุนูุงู)*%0a`;
            msg += `๐ค ุงูุงุณู: ${name}%0a๐ฑ ุงููุงุชู: ${phone}%0a๐ ุงูุนููุงู: ${city} - ${address}%0a`;
            msg += `---------------------------%0a*ุงูููุชุฌุงุช:*%0a`;
            let total = 0;
            for (const item of cart) {
                const product = window.allProducts.find(p => p.id === item.id);
                if (product) {
                    const itemTotal = product.sale_price * item.quantity;
                    total += itemTotal;
                    msg += `โช๏ธ ${product.title} (x${item.quantity}) - ${itemTotal.toFixed(2)} ุฑ.ุน.%0a`;
                }
            }
            msg += `---------------------------%0a๐ฐ *ุงูุฅุฌูุงูู: ${total.toFixed(2)} ุฑูุงู ุนูุงูู*`;

            localStorage.removeItem('cart');
            window.open(`https://wa.me/201110760081?text=${msg}`, '_blank');
            window.location.href = '../pages/thankyou.html';
        }
    </script>
</body>
</html>
