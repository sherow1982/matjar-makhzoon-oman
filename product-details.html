<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- سيتم تحديث العنوان والوصف عبر الجافاسكريبت -->
    <title>تفاصيل المنتج</title> 
    <meta name="description" content="">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- تحميل أيقونات Font Awesome بشكل غير حاجب للعرض -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
    <script src="main.js" defer></script>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T67556JM"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- الشريط العلوي -->
    <div class="top-bar">
        <div class="container flex-between">
            <div class="contact-info">
                <a href="https://wa.me/201110760081" target="_blank" class="top-link">
                    <i class="fab fa-whatsapp"></i> 201110760081+
                </a>
                <span class="sep">|</span>
                <a href="mailto:info@arabsad.com" class="top-link">
                    <i class="fas fa-envelope"></i> info@arabsad.com
                </a>
            </div>
            <div class="shipping-note">
                <a href="pages/shipping.html" class="top-link">الشحن المجاني</a>
                <span class="sep">|</span>
                <a href="pages/returns.html" class="top-link">الاسترجاع</a>
                <span class="sep">|</span>
                <a href="pages/terms.html" class="top-link">الشروط</a>
            </div>
        </div>
    </div>

    <!-- الهيدر الرئيسي -->
    <header class="main-header">
        <div class="container flex-between header-content-wrap">
            <!-- زر هامبرجر (يظهر على الموبايل فقط) -->
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="فتح القائمة">
                <i class="fas fa-bars"></i>
            </button>

            <a href="index.html" class="logo">
                <span class="omani-red">مخزون</span> <span class="omani-green">عمان</span>
            </a>
            
            <div class="search-box">
                <div class="search-wrapper">
                    <input type="text" id="search-input" placeholder="ابحث عن منتج..." onkeypress="handleEnter(event)" autocomplete="off">
                </div>
                <button onclick="window.location.href='index.html?search=' + document.getElementById('search-input').value"><i class="fas fa-search"></i></button>
            </div>

            <div class="header-icons">
                <div class="cart-icon" onclick="toggleCart()">
                    <i class="fas fa-shopping-bag"></i>
                    <span id="cart-count">0</span>
                    <span class="cart-text">السلة</span>
                </div>
            </div>
        </div>
    </header>

    <!-- القائمة الجانبية للموبايل -->
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
            <h3><i class="fas fa-list"></i> القائمة</h3>
            <span class="close-mobile-menu" onclick="toggleMobileMenu()">&times;</span>
        </div>
        <div class="mobile-menu-content">
            <div class="mobile-search-box">
                <input type="text" id="mobile-search-input" placeholder="ابحث عن منتج..." onkeypress="if(event.key === 'Enter') window.location.href='index.html?search=' + this.value">
                <button onclick="window.location.href='index.html?search=' + document.getElementById('mobile-search-input').value"><i class="fas fa-search"></i></button>
            </div>
            <nav class="mobile-nav-links">
                <a href="index.html" class="mobile-nav-link"><i class="fas fa-home"></i> الرئيسية</a>
                <a href="pages/shipping.html" class="mobile-nav-link"><i class="fas fa-shipping-fast"></i> سياسة الشحن</a>
                <a href="pages/returns.html" class="mobile-nav-link"><i class="fas fa-undo"></i> الاسترجاع</a>
                <a href="pages/terms.html" class="mobile-nav-link"><i class="fas fa-file-contract"></i> الشروط والأحكام</a>
                <a href="pages/privacy.html" class="mobile-nav-link"><i class="fas fa-shield-alt"></i> سياسة الخصوصية</a>
                <a href="pages/contact.html" class="mobile-nav-link"><i class="fas fa-envelope"></i> تواصل معنا</a>
            </nav>
        </div>
    </div>

    <main class="container main-content-area">
        <nav class="breadcrumb" id="breadcrumb-nav">
            <a href="index.html">الرئيسية</a> &gt; <span id="product-breadcrumb-name">المنتج</span>
        </nav>
        <div class="single-product-container">
            <div class="product-gallery">
                <div class="main-image-container">
                    <img id="main-product-image" src="images/placeholder.png" alt="جاري تحميل صورة المنتج">
                </div>
                <div id="product-thumbnails" class="thumbnail-container"></div>
            </div>
            <div class="single-details">
                <h1 id="product-title">جاري تحميل تفاصيل المنتج...</h1>
                <div id="product-meta" class="product-meta-tags"></div>
                <div id="product-price-container"></div>
                <div id="product-description" style="white-space: pre-wrap;"></div>
                <div class="product-actions">
                    <button id="add-to-cart-details" class="add-to-cart-btn">
                        <i class="fas fa-cart-plus"></i> أضف للسلة
                    </button>
                    <button id="whatsapp-button" class="btn-whatsapp-large">
                        <i class="fab fa-whatsapp"></i> اطلب عبر واتساب
                    </button>
                </div>
            </div>
        </div>
        <!-- قسم المنتجات ذات الصلة -->
        <div id="related-products-section"></div>
    </main>

    <!-- القائمة الجانبية للسلة -->
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> سلة المشتريات</h3>
            <span class="close-cart" onclick="toggleCart()">&times;</span>
        </div>
        <div class="cart-items" id="cart-items"><p class="empty-cart-message">سلّتك فارغة حالياً.</p></div>
        <div class="cart-footer">
            <div class="total-row-cart">
                <span>المجموع:</span>
                <span id="cart-total" class="omani-green">0.00 ر.ع.</span>
            </div>
            <p class="tax-note">الشحن والضريبة يحسبان عند إتمام الطلب</p>
            <button class="checkout-btn" onclick="checkoutPage()">
                <i class="fas fa-check-circle"></i> إتمام الطلب
            </button>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleCart()"></div>
    <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>

    <!-- الفوتر -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>جميع الحقوق محفوظة © 2025 متجر مخزون عمان</p>
            </div>
        </div>
    </footer>

    <script src="loader.js" defer></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get('id'));
        
        // انتظر حتى يتم تحميل المنتجات في loader.js
        const checkProductsLoaded = setInterval(() => {
            if (window.allProducts && window.allProducts.length > 0) {
                clearInterval(checkProductsLoaded);
                renderProductDetails(window.allProducts, productId);
            }
        }, 100);

        function renderProductDetails(allProducts, productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                try {
                    // ملء بيانات الصفحة
                    const cleanDescription = product.description.replace(/\\n|\\t/g, ' ').replace(/\s+/g, ' ').trim();
                    const metaDescription = cleanDescription.substring(0, 155) + (cleanDescription.length > 155 ? '...' : '');

                    document.title = product.title + " | متجر مخزون عمان";
                    document.querySelector('meta[name="description"]').setAttribute("content", metaDescription);
                    
                    renderGallery(product);

                    document.getElementById('product-title').innerText = product.title;
                    document.getElementById('product-breadcrumb-name').innerText = product.title;
                    document.getElementById('product-description').innerText = product.description.replace(/\\t/g, '    ').replace(/\\n/g, '\n');

                    const priceContainer = document.getElementById('product-price-container');
                    const salePrice = parseFloat(product.sale_price);
                    const originalPrice = parseFloat(product.price);
                    if (originalPrice > salePrice) {
                        const discount = Math.round(((originalPrice - salePrice) / originalPrice) * 100);
                        priceContainer.innerHTML = `
                            <div class="price-wrapper">
                                <span class="sale-price">${salePrice.toFixed(2)} ر.ع.</span> 
                                <span class="original-price">${originalPrice.toFixed(2)} ر.ع.</span>
                            </div>
                            <div class="save-badge">وفر ${discount}%</div>
                        `;
                    } else {
                        priceContainer.innerHTML = `<div class="price-wrapper"><span class="price-normal">${salePrice.toFixed(2)} ر.ع.</span></div>`;
                    }

                    // ملء البيانات الوصفية
                    const metaContainer = document.getElementById('product-meta');
                    metaContainer.innerHTML = `
                        ${product.brand ? `<div class="meta-item"><strong>العلامة التجارية:</strong> <span>${product.brand}</span></div>` : ''}
                        <div class="meta-item"><strong>التوفر:</strong> <span class="stock-status in-stock">متوفر</span></div>
                        <div class="meta-item"><strong>الشحن:</strong> <span>يتم التوصيل خلال 1-3 أيام</span></div>
                    `;


                    // ربط زر الإضافة للسلة
                    const addToCartBtn = document.getElementById('add-to-cart-details');
                    addToCartBtn.onclick = (event) => addToCart(product.id, event);

                    // ربط زر الواتساب
                    const whatsappButton = document.getElementById('whatsapp-button');
                    if (whatsappButton) {
                        const whatsappMessage = `أهلاً مخزون عمان،\nأرغب في طلب المنتج التالي:\n\n*${product.title}*\n\nالرابط: ${window.location.href}`;
                        const whatsappURL = `https://wa.me/201110760081?text=${encodeURIComponent(whatsappMessage)}`;
                        whatsappButton.onclick = () => window.open(whatsappURL, '_blank');
                    }

                    // عرض المنتجات ذات الصلة
                    displayRelatedProducts(allProducts, product.id);

                    // *** هذا هو الجزء الأهم: إنشاء وإضافة سكيما المنتج ***
                    const schema = {
                        "@context": "https://schema.org",
                        "@type": "Product",
                        "name": product.title,
                        "image": product['image link'],
                        "description": product.description,
                        "sku": product.sku,
                        "mpn": product.sku,
                        "brand": {
                            "@type": "Brand",
                            "name": product.brand || "مخزون عمان"
                        },
                        "offers": {
                            "@type": "Offer",
                            "url": window.location.href,
                            "priceCurrency": "OMR",
                            "price": product.sale_price,
                            ...(product.price > product.sale_price && {
                                "priceValidUntil": new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                                "mainPrice": product.price 
                            }),
                            "itemCondition": "https://schema.org/NewCondition",
                            "availability": "https://schema.org/InStock"
                        }
                    };

                    const schemaScript = document.createElement('script');
                    schemaScript.type = 'application/ld+json';
                    schemaScript.textContent = JSON.stringify(schema);
                    // إزالة أي سكيما قديمة قبل إضافة الجديدة
                    const oldSchema = document.querySelector('script[type="application/ld+json"]');
                    if(oldSchema) oldSchema.remove();
                    document.head.appendChild(schemaScript);
                } catch (error) {
                    console.error("Error rendering product details:", error);
                }
            } else {
                    document.querySelector('.single-product-container').innerHTML = `<p class="error-message">عفواً، المنتج الذي تبحث عنه غير موجود.</p>`;
            }
        }
    });

    function renderGallery(product) {
        const mainImage = document.getElementById('main-product-image');
        const thumbnailsContainer = document.getElementById('product-thumbnails');

        const images = [product['image link']];
        if (product['additional image link']) {
            images.push(product['additional image link']);
        }

        mainImage.src = images[0];
        mainImage.alt = product.title;

        thumbnailsContainer.innerHTML = images.map((imgSrc, index) => `
            <img src="${imgSrc}" 
                 alt="صورة مصغرة ${index + 1}" 
                 class="thumbnail-image ${index === 0 ? 'active' : ''}"
                 onclick="changeMainImage('${imgSrc}', this)">
        `).join('');
    }

    window.changeMainImage = function(src, thumbElement) {
        document.getElementById('main-product-image').src = src;
        document.querySelectorAll('.thumbnail-image').forEach(el => el.classList.remove('active'));
        thumbElement.classList.add('active');
    }

    // دالة لعرض المنتجات ذات الصلة
    function displayRelatedProducts(allProducts, currentProductId) {
        const relatedSection = document.getElementById('related-products-section');
        if (!relatedSection) return;

        // ترشيح المنتجات لاستبعاد المنتج الحالي
        let relatedProducts = allProducts.filter(p => p.id !== currentProductId);

        // خلط المنتجات وعرض 4 منها فقط
        relatedProducts = relatedProducts.sort(() => 0.5 - Math.random()).slice(0, 4);

        if (relatedProducts.length > 0) {
            const relatedHTML = `
                <h2 class="section-title">قد يعجبك أيضاً</h2>
                <div class="products-grid">
                    ${relatedProducts.map(product => createProductCard(product)).join('')}
                </div>
            `;
            relatedSection.innerHTML = relatedHTML;
        }
    }

    // يجب أن تكون دالة createProductCard متاحة هنا أيضاً
    // بما أن loader.js يتم تحميله، ستكون الدالة متاحة في النطاق العام (window)
    // أو يمكن نسخها هنا لضمان عملها بشكل مستقل.
    // للسهولة، سنعتمد على أن loader.js يجعلها متاحة.

    </script>

</body>
</html>